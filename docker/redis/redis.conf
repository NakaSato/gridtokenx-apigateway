# Redis Configuration for GridTokenX API Gateway
# Production-ready configuration with security and performance optimizations

# =========================================================================
# NETWORK CONFIGURATION
# =========================================================================

# Accept connections on all interfaces in container, restrict to specific in production
bind 0.0.0.0

# Default Redis port
port 6379

# Timeout for idle client connections
timeout 300

# TCP keepalive
tcp-keepalive 300

# =========================================================================
# SECURITY CONFIGURATION
# =========================================================================

# Require authentication (password set via Docker environment)
# Note: In production, use a strong password and set via Docker secrets
requirepass ${REDIS_PASSWORD}

# Rename dangerous commands for security
rename-command CONFIG ""
rename-command SHUTDOWN ""
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command DEBUG ""
rename-command EVAL ""

# Disable dangerous commands completely
# rename-command "" ""

# =========================================================================
# MEMORY MANAGEMENT
# =========================================================================

# Maximum memory usage (adjust based on available resources)
# 2GB default, adjust based on container limits
maxmemory 2gb

# Memory eviction policy when maxmemory is reached
# allkeys-lru: Evict least recently used keys of any type
maxmemory-policy allkeys-lru

# Number of Redis databases (reduce to 1 for simplicity)
databases 1

# =========================================================================
# PERSISTENCE CONFIGURATION
# =========================================================================

# RDB (Redis Database) snapshots
# Save if at least 1 key changed in 15 minutes
save 900 1

# Save if at least 10 keys changed in 5 minutes
save 300 10

# Save if at least 10000 keys changed in 1 minute
save 60 10000

# RDB file name
dbfilename dump.rdb

# RDB file directory
dir /data

# Compression for RDB files
rdbcompression yes

# RDB checksum for error detection
rdbchecksum yes

# Stop writing to RDB if there are errors
stop-writes-on-bgsave-error yes

# AOF (Append Only File) for durability
appendonly yes
appendfilename "appendonly.aof"

# AOF fsync policy
# everysec: fsync every second (good balance between performance and durability)
appendfsync everysec

# AOF rewrite policy
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# AOF load truncated files
aof-load-truncated yes

# =========================================================================
# REPLICATION CONFIGURATION
# =========================================================================

# Master replication settings (for future clustering)
# replica-serve-stale-data yes
# replica-read-only yes
# repl-diskless-sync no
# repl-diskless-sync-delay 5

# =========================================================================
# LOGGING CONFIGURATION
# =========================================================================

# Log level (notice for production, debug for development)
loglevel notice

# Log file path (container logs will capture this)
logfile ""

# Enable syslog (optional for production)
# syslog-enabled yes

# =========================================================================
# CLIENT CONFIGURATION
# =========================================================================

# Maximum number of connected clients
maxclients 10000

# =========================================================================
# PERFORMANCE TUNING
# =========================================================================

# TCP backlog size (connection queue)
tcp-backlog 511

# Overcommit memory setting
overcommit-memory 1

# Lazy expiration (free memory asynchronously)
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no

# Hash table settings (auto-scaling)
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List settings
list-max-ziplist-size -2
list-compress-depth 0

# Set settings
set-max-intset-entries 512

# Sorted set settings
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog settings
hll-sparse-max-bytes 3000

# Stream settings
stream-node-max-bytes 4096
stream-node-max-entries 100

# =========================================================================
# SLOW LOG CONFIGURATION
# =========================================================================

# Log slow queries (slower than 10ms)
slowlog-log-slower-than 10000

# Maximum number of slow log entries
slowlog-max-len 128

# =========================================================================
# LATENCY MONITORING
# =========================================================================

# Enable latency monitoring
latency-monitor-threshold 100

# =========================================================================
# ADVANCED CONFIGURATION
# =========================================================================

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Frequency of background saves
rdb-save-incremental-fsync yes

# Minimum amount of memory to leave for the system
reserved-memory-slots 256

# =========================================================================
# TLS CONFIGURATION (Production Only)
# =========================================================================

# Enable TLS (uncomment for production with certificates)
# tls-port 6380
# tls-cert-file /etc/redis/tls/redis.crt
# tls-key-file /etc/redis/tls/redis.key
# tls-ca-cert-file /etc/redis/tls/ca.crt

# Require TLS for clients
# tls-ca-cert-dir /etc/redis/tls/
# tls-auth-clients yes

# =========================================================================
# MODULES CONFIGURATION
# =========================================================================

# Load Redis modules (uncomment as needed)
# loadmodule /usr/local/lib/redis-modules/redistimeseries.so
# loadmodule /usr/local/lib/redis-modules/redisjson.so
# loadmodule /usr/local/lib/redis-modules/redisbloom.so

# =========================================================================
# CLUSTER CONFIGURATION (Future Enhancement)
# =========================================================================

# Enable cluster mode (uncomment for clustering)
# cluster-enabled yes
# cluster-config-file nodes.conf
# cluster-node-timeout 5000
# cluster-announce-ip ${REDIS_ADVERTISE_IP}
# cluster-announce-port 6379
# cluster-announce-bus-port 16379

# =========================================================================
# MONITORING AND METRICS
# =========================================================================

# Enable command stats for monitoring
commandstats yes

# Enable info command sections
info-command yes

# Enable metrics collection
# metrics-enabled yes

# =========================================================================
# DEVELOPMENT/DEBUG SETTINGS
# =========================================================================

# Enable protected mode (only accessible from localhost without authentication)
protected-mode no

# Enable debug messages in development
# debug-mode yes

# =========================================================================
# GridTokenX Specific Settings
# =========================================================================

# Custom settings for GridTokenX application

# Market data specific eviction
# Keep market data longer than other data
# Note: This would require custom implementation

# Pub/Sub settings
# Maximum number of pub/sub channels
pubsub-channel-queue-length 10000

# Transaction settings
# Maximum number of watched keys in a transaction
watch-queue-length 1024

# Sort settings
# Maximum memory for sort operations
sort-buffer-max-bytes 64mb

# =========================================================================
# PERFORMANCE PROFILES
# =========================================================================

# Uncomment one of these profiles based on environment

# Development Profile (more logging, less strict security)
# loglevel debug
# save 60 1
# maxmemory 1gb

# Production Profile (optimized for performance and security)
# loglevel notice
# save 900 1
# save 300 10
# save 60 10000
# maxmemory 4gb
# maxmemory-policy allkeys-lru

# High-Performance Profile (minimal persistence, maximum speed)
# save ""
# appendonly no
# maxmemory 8gb
# maxmemory-policy volatile-lru

# =========================================================================
# NOTES
# =========================================================================

# This configuration is optimized for Docker container deployment
# Adjust memory limits based on container resource allocation
# Monitor memory usage and adjust maxmemory accordingly
# Regular backup strategy required for AOF/RDB files
# Consider Redis Cluster for horizontal scaling beyond single instance
