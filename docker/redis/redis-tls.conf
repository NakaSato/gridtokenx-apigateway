# Redis Configuration with TLS for GridTokenX API Gateway
# Production-ready configuration with security hardening and TLS encryption

# =========================================================================
# NETWORK CONFIGURATION WITH TLS
# =========================================================================

# Disable plain text port for production
port 0

# Enable TLS port
tls-port 6380

# Accept connections on all interfaces in container, restrict to specific in production
bind 0.0.0.0

# Timeout for idle client connections
timeout 300

# TCP keepalive
tcp-keepalive 300

# =========================================================================
# TLS CONFIGURATION
# =========================================================================

# TLS certificate files
tls-cert-file /etc/redis/tls/redis-cert.pem
tls-key-file /etc/redis/tls/redis-key.pem
tls-ca-cert-file /etc/redis/tls/ca-cert.pem
tls-dh-params-file /etc/redis/tls/dhparam.pem

# TLS settings
tls-protocols "TLSv1.2 TLSv1.3"
tls-ciphers "ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256"
tls-prefer-server-ciphers yes
tls-session-caching no
tls-session-cache-size 5000
tls-session-cache-timeout 60

# Client authentication
tls-auth-clients yes
tls-replication yes

# =========================================================================
# SECURITY CONFIGURATION
# =========================================================================

# Require authentication (password set via Docker environment)
requirepass ${REDIS_PASSWORD}

# Rename dangerous commands for security
rename-command CONFIG ""
rename-command SHUTDOWN ""
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command DEBUG ""
rename-command EVAL ""

# Disable dangerous commands completely
# rename-command "" ""

# =========================================================================
# MEMORY MANAGEMENT
# =========================================================================

# Maximum memory usage (adjust based on available resources)
maxmemory 2gb

# Memory eviction policy when maxmemory is reached
maxmemory-policy allkeys-lru

# Number of Redis databases (reduce to 1 for simplicity)
databases 1

# =========================================================================
# PERSISTENCE CONFIGURATION
# =========================================================================

# RDB (Redis Database) snapshots
save 900 1
save 300 10
save 60 10000

# RDB file name
dbfilename dump.rdb

# RDB file directory
dir /data

# Compression for RDB files
rdbcompression yes

# RDB checksum for error detection
rdbchecksum yes

# Stop writing to RDB if there are errors
stop-writes-on-bgsave-error yes

# AOF (Append Only File) for durability
appendonly yes
appendfilename "appendonly.aof"

# AOF fsync policy
appendfsync everysec

# AOF rewrite policy
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# AOF load truncated files
aof-load-truncated yes

# =========================================================================
# REPLICATION CONFIGURATION
# =========================================================================

# Master replication settings (for future clustering)
# replica-serve-stale-data yes
# replica-read-only yes
# repl-diskless-sync no
# repl-diskless-sync-delay 5

# =========================================================================
# LOGGING CONFIGURATION
# =========================================================================

# Log level (notice for production, debug for development)
loglevel notice

# Log file path (container logs will capture this)
logfile ""

# =========================================================================
# CLIENT CONFIGURATION
# =========================================================================

# Maximum number of connected clients
maxclients 10000

# =========================================================================
# PERFORMANCE TUNING
# =========================================================================

# TCP backlog size (connection queue)
tcp-backlog 511

# Overcommit memory setting
overcommit-memory 1

# Lazy expiration (free memory asynchronously)
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no

# Hash table settings (auto-scaling)
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List settings
list-max-ziplist-size -2
list-compress-depth 0

# Set settings
set-max-intset-entries 512

# Sorted set settings
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog settings
hll-sparse-max-bytes 3000

# Stream settings
stream-node-max-bytes 4096
stream-node-max-entries 100

# =========================================================================
# SLOW LOG CONFIGURATION
# =========================================================================

# Log slow queries (slower than 10ms)
slowlog-log-slower-than 10000

# Maximum number of slow log entries
slowlog-max-len 128

# =========================================================================
# LATENCY MONITORING
# =========================================================================

# Enable latency monitoring
latency-monitor-threshold 100

# =========================================================================
# ADVANCED CONFIGURATION
# =========================================================================

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Frequency of background saves
rdb-save-incremental-fsync yes

# Minimum amount of memory to leave for the system
reserved-memory-slots 256

# =========================================================================
# MODULES CONFIGURATION
# =========================================================================

# Load Redis modules (uncomment as needed)
# loadmodule /usr/local/lib/redis-modules/redistimeseries.so
# loadmodule /usr/local/lib/redis-modules/redisjson.so
# loadmodule /usr/local/lib/redis-modules/redisbloom.so

# =========================================================================
# MONITORING AND METRICS
# =========================================================================

# Enable command stats for monitoring
commandstats yes

# Enable info command sections
info-command yes

# =========================================================================
# GridTokenX Specific Settings
# =========================================================================

# Custom settings for GridTokenX application

# Market data specific eviction
# Keep market data longer than other data
# Note: This would require custom implementation

# Pub/Sub settings
# Maximum number of pub/sub channels
pubsub-channel-queue-length 10000

# Transaction settings
# Maximum number of watched keys in a transaction
watch-queue-length 1024

# Sort settings
# Maximum memory for sort operations
sort-buffer-max-bytes 64mb

# =========================================================================
# PRODUCTION PROFILE
# =========================================================================

# This configuration uses the production profile:
# loglevel notice
# save 900 1
# save 300 10
# save 60 10000
# maxmemory 2gb
# maxmemory-policy allkeys-lru

# =========================================================================
# SECURITY NOTES
# =========================================================================

# This configuration includes:
# 1. TLS encryption for all connections
# 2. Certificate-based client authentication
# 3. Password authentication
# 4. Command renaming for security
# 5. Network isolation recommendations
# 
# For production deployment:
# 1. Use certificates signed by a trusted CA
# 2. Configure Redis on a private network
# 3. Use firewall rules to restrict access
# 4. Monitor for security events
# 5. Regular certificate rotation
