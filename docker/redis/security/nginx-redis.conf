# Nginx Configuration for Redis Proxy and Security
# Provides additional security layer for Redis connections

events {
    worker_connections 1024;
}

http {
    # Redis health check endpoint
    server {
        listen 80;
        server_name redis-health.gridtokenx.local;
        
        location /health {
            access_log off;
            return 200 "Redis proxy healthy\n";
            add_header Content-Type text/plain;
        }
    }
}

# Stream module for TCP proxying
stream {
    # Redis proxy with TLS termination
    upstream redis_backend {
        server redis:6380;
        # Add multiple Redis instances for load balancing in future
        # server redis2:6380 backup;
    }
    
    # Redis proxy server
    server {
        listen 6379;
        proxy_pass redis_backend;
        proxy_timeout 1s;
        proxy_responses 1;
        proxy_bind $remote_addr transparent;
        
        # Security settings
        proxy_connect_timeout 1s;
        proxy_download_rate 1m;
        proxy_upload_rate 1m;
        
        # IP whitelist (uncomment and configure for production)
        # allow 10.0.0.0/8;
        # allow 172.16.0.0/12;
        # allow 192.168.0.0/16;
        # deny all;
    }
    
    # Redis TLS proxy (for clients that don't support TLS)
    server {
        listen 6380 ssl;
        proxy_pass redis_backend;
        proxy_timeout 1s;
        proxy_responses 1;
        
        # SSL configuration
        ssl_certificate /etc/ssl/certs/redis-proxy.crt;
        ssl_certificate_key /etc/ssl/private/redis-proxy.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        
        # Client certificate verification (optional)
        # ssl_client_certificate /etc/ssl/certs/redis-ca.crt;
        # ssl_verify_client on;
        
        # Security headers
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Frame-Options DENY always;
        add_header X-Content-Type-Options nosniff always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    }
    
    # Redis monitoring endpoint (restricted access)
    server {
        listen 6381;
        proxy_pass redis_backend;
        
        # Access control
        allow 127.0.0.1;
        allow 10.0.0.0/8;
        allow 172.16.0.0/12;
        allow 192.168.0.0/16;
        deny all;
        
        # Rate limiting
        limit_conn_zone $binary_remote_addr zone=redis_monitoring:10m;
        limit_conn redis_monitoring 10;
        limit_req_zone $binary_remote_addr zone=redis_monitoring_req:10m rate=5r/s;
        limit_req zone=redis_monitoring_req burst=10 nodelay;
    }
}

# Log format for Redis connections
log_format redis_proxy '$remote_addr [$time_local] '
                       '$protocol $status $bytes_sent $bytes_received '
                       '$session_time "$upstream_addr" '
                       '"$upstream_bytes_sent" "$upstream_bytes_received" '
                       '$upstream_connect_time $upstream_first_byte_time $upstream_session_time';

# Access log
access_log /var/log/nginx/redis_access.log redis_proxy;
error_log /var/log/nginx/redis_error.log warn;
